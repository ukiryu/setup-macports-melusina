#!/bin/sh

# configure_macports — Configure MacPorts

# Melusina Actions (https://github.com/melusina-org/setup-macports)
# This file is part of Melusina Actions.
#
# Copyright © 2022–2023 Michaël Le Barbier
# All rights reserved.

# This file must be used under the terms of the MIT License.
# This source file is licensed as described in the file LICENSE, which
# you should have received as part of this distribution. The terms
# are also available at https://opensource.org/licenses/MIT

: ${TOPLEVELDIR:=$(git rev-parse --show-toplevel)}
: ${subrdir:=${TOPLEVELDIR}/subr}
: ${PREPEND_PATHS:='true'}
: ${SIGNATURE_CHECK:='true'}

. "${subrdir}/stdlib.sh"
. "${subrdir}/macos.sh"
. "${subrdir}/macports.sh"

github_owner='macports'
github_repo='macports-base'

parameterfile='.github/parameters/setup-macports.yaml'
parameterfile_compat='.github/parameters/gha-install-macports.yaml'

usage()
{
    if [ "$#" -gt 0 ]; then
	wlog 'Failure' "$@"
    fi
    cat 1>&2 <<'EOF'
Usage: configure_macports [VERSION-OR-PATHNAME]
 Configure MacPorts
EOF
    exit 64
}

experimental()
{
    :
}

: ${cache_version:=2}

cache_key()
{
    local macos arch
    macos=$(probe_macos)
    arch=$(probe_architecture)
    openssl ripemd160 "${macports_prefix}/etc/setup-macports.yaml"\
	| awk -v "macos=${macos}" -v "arch=${arch}" -v "ver=${cache_version}" '{print(macos "-" arch "-" ver "-" $2)}'
}

setup_path()
{
    sudo install -o root -g wheel -m 644 /dev/null /etc/paths.d/900-macports
    sudo sh -c "printf '%s/bin\n/' ${macports_prefix} > /etc/paths.d/900-macports" 
    sudo sh -c "printf '%s/sbin\n/' ${macports_prefix} > /etc/paths.d/900-macports"
    PATH="${macports_prefix}/bin:${macports_prefix}/sbin:${PATH}"
}

main()
{
    local OPTIND OPTION OPTARG
    local macos package action

    ensure_macos
    action='install'
    macos=$(probe_macos)
    OPTIND=1
    while getopts 'x' OPTION; do
        case ${OPTION} in
            x)
		action='experimental'
		;;
            *)
		usage '\047%s\047 Unsupported option.' "${OPTION}"
		;;
        esac
    done

    shift $(expr ${OPTIND} - 1)

    case "$#" in
	0)
	    :
	    ;;
	1)
	    if [ -f "$1" -a -r "$1" ]; then
		parameterfile="$1"
	    elif [ "$1" = ':no-value' -a -f "${parameterfile}" -a -r "${parameterfile}" ]; then
		wlog 'Info' 'Use parameter file \047%s\047.' "${parameterfile}"
	    elif [ "$1" = ':no-value' -a -f "${parameterfile_compat}" -a -r "${parameterfile_compat}" ]; then
		wlog 'Info' 'Use parameter file \047%s\047.' "${parameterfile_compat}"
		parameterfile="${parameterfile_compat}"
	    else
		parameterfile=':no-value'
	    fi
	    ;;
	*)
	    usage 'Too many arguments.'
	    ;;
    esac

    if [ -f "${parameterfile}" -a -r "${parameterfile}" ]; then
	macports_version=$(yq ".version // \"${macports_version}\"" < "${parameterfile}")
	macports_prefix=$(yq ".prefix // \"${macports_prefix}\"" < "${parameterfile}")
    fi

    if [ "${action}" = 'experimental' ]; then
	experimental "$@"
	exit 0
    fi

    setup_path
    sudo install -d -o $(id -u -n) -g $(id -g -n) -m 755 "${macports_prefix}"
    write_configuration "${parameterfile}" "${macports_prefix}/etc/setup-macports.yaml"
    write_variants "${macports_prefix}/etc/setup-macports.yaml"
    write_sources "${macports_prefix}/etc/setup-macports.yaml"

    # Write macports.conf with required settings
    macports_install -d -m 755 "${macports_prefix}/etc/macports"
    local macports_conf="${macports_prefix}/etc/macports/macports.conf"

    # Create fresh macports.conf file with all required settings
    # Use redirect to ensure we always create a new file
    cat > "${macports_conf}" <<EOF
prefix ${macports_prefix}
portdbpath ${macports_prefix}/var/macports/portdbpath
sources_conf ${macports_prefix}/etc/macports/sources.conf
EOF

    # Set signature_check based on SIGNATURE_CHECK environment variable
    if [ "${SIGNATURE_CHECK}" = 'true' ]; then
	printf 'signature_check yes\n' >> "${macports_conf}"
    else
	printf 'signature_check no\n' >> "${macports_conf}"
    fi

    # Verify macports.conf was written correctly
    if [ ! -s "${macports_conf}" ]; then
	failwith 'Failed to write macports.conf at %s' "${macports_conf}"
    fi

    wlog 'Info' "Configured macports.conf at ${macports_conf}"

    # Check if using git sources for output
    # Auto-detect if .macports-ports exists in workspace
    local uses_git_sources='false'
    if [ -d "${GITHUB_WORKSPACE}/.macports-ports/.git" ]; then
	uses_git_sources='true'
    elif [ -f "${parameterfile}" -a -r "${parameterfile}" ]; then
	# Check if sources in parameter file are git URLs
	local first_source
	first_source=$(yq '.sources[0] // "rsync://rsync.macports.org/macports/release/tarballs/ports.tar"' < "${parameterfile}")
	case "${first_source}" in
	    https://github.com/*/*|git@github.com:*/*|git://github.com/*/*)
		uses_git_sources='true'
		;;
	esac
    fi

    if [ "${GITHUB_ACTIONS}" = 'true' ]; then
	{
	    printf 'prefix=%s\n' "${macports_prefix}"
	    printf 'parameters=%s\n' "${macports_prefix}/etc/setup-macports.yaml"
	    printf 'cache-key=%sn\n' "$(cache_key)"
            printf 'package=%s\n' "$(make_package)"
            printf 'version=%s\n' "${macports_version}"
            printf 'uses-git-sources=%s\n' "${uses_git_sources}"
	} >> "${GITHUB_OUTPUT}"

        if [ "${PREPEND_PATHS}" = 'true' ]; then
	    {
	        printf '%s/bin\n' "${macports_prefix}"
                printf '%s/sbin\n' "${macports_prefix}"
	    } >> "${GITHUB_PATH}"
	fi
    fi 
}

main "$@"

# End of file `configure_macports'
