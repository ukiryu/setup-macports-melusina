#!/bin/sh

# macos — Testsuite for MacOS functions

# Melusina Actions (https://github.com/melusina-org/setup-macports)
# This file is part of Melusina Actions.
#
# Copyright © 2022–2023 Michaël Le Barbier
# All rights reserved.

# This file must be used under the terms of the MIT License.
# This source file is licensed as described in the file LICENSE, which
# you should have received as part of this distribution. The terms
# are also available at https://opensource.org/licenses/MIT

: ${TOPLEVELDIR:=$(git rev-parse --show-toplevel)}
: ${subrdir:=${TOPLEVELDIR}/subr}

. "${subrdir}/stdlib.sh"
. "${subrdir}/macos.sh"
. "${subrdir}/testsuite.sh"

assume_running_on_macos11()
{
    system_profiler()
    (
	cat <<'EOF'
Software:

    System Software Overview:

      System Version: macOS 11.7.2 (20G1020)
      Kernel Version: Darwin 20.6.0
      Boot Volume: Macintosh HD
      Boot Mode: Normal
      Computer Name: Assume.local
      User Name: runner (runner)
      Secure Virtual Memory: Enabled
      System Integrity Protection: Enabled
      Time since boot: 3 minutes

EOF
	exit 0
)

    uname()
    (
	echo 'Darwin'
	exit 0
    )
}

assume_running_on_macos12()
{
    system_profiler()
    (
	cat <<'EOF'
Software:

    System Software Overview:

      System Version: macOS 12.6.2 (21G320)
      Kernel Version: Darwin 21.6.0
      Boot Volume: Macintosh HD
      Boot Mode: Normal
      Computer Name: Assume.local
      User Name: runner (runner)
      Secure Virtual Memory: Enabled
      System Integrity Protection: Enabled
      Time since boot: 3 minutes

EOF
	exit 0
    )

    uname()
    (
	echo 'Darwin'
	exit 0
    )
}

assume_running_on_macos26()
{
    system_profiler()
    (
	cat <<'EOF'
Software:

    System Software Overview:

      System Version: macOS 26.0 (25A354)
      Kernel Version: Darwin 25.0.0
      Boot Volume: Macintosh HD
      Boot Mode: Normal
      Computer Name: Assume.local
      User Name: runner (runner)
      Secure Virtual Memory: Enabled
      System Integrity Protection: Enabled
      Time since boot: 3 minutes
EOF
	exit 0
    )

    uname()
    (
	echo 'Darwin'
	exit 0
    )
}

assume_running_on_linux()
{
    system_profiler()
    (
	eprintf 'No such file or directory: system_profiler\n'
	exit 127
    )	

    uname()
    (
	echo 'Linux'
	exit 0
    )
    
}

assert_that_macos11_is_detected()
(
    assume_running_on_macos11
    macos=$(probe_macos)
    if (ensure_macos); then
	macosp='true'
    else
	macosp='false'
    fi
    set -e
    test "${macos}" = 'BigSur'
    test "${macosp}" = 'true'
)

assert_that_macos12_is_detected()
(
    assume_running_on_macos12
    macos=$(probe_macos)
     if (ensure_macos); then
	macosp='true'
    else
	macosp='false'
    fi
    set -e
    test "${macos}" = 'Monterey'
    test "${macosp}" = 'true'
)

assert_that_macos26_is_detected()
(
    assume_running_on_macos26
    macos=$(probe_macos)
     if (ensure_macos); then
	macosp='true'
    else
	macosp='false'
    fi
    set -e
    test "${macos}" = 'Tahoe'
    test "${macosp}" = 'true'
)

assert_that_linux_is_detected()
(
    assume_running_on_linux
    macos=$(probe_macos)
    if (ensure_macos); then
	macosp='true'
    else
	macosp='false'
    fi
    set -ex
    test "${macos}" = ':not-found'
    test "${macosp}" = 'false'
)

# Mock uname -m for architecture testing
mock_uname_arm64()
{
    uname()
    {
	echo 'arm64'
    }
}

mock_uname_x86_64()
{
    uname()
    {
	echo 'x86_64'
    }
}

mock_uname_unknown()
{
    uname()
    {
	echo 'unknown_arch'
    }
}

assert_that_arm64_architecture_is_detected()
(
    mock_uname_arm64
    arch=$(probe_architecture)
    set -e
    test "${arch}" = 'arm64'
)

assert_that_x86_64_architecture_is_detected()
(
    mock_uname_x86_64
    arch=$(probe_architecture)
    set -e
    test "${arch}" = 'x86_64'
)

assert_that_unknown_architecture_returns_unknown()
(
    mock_uname_unknown
    arch=$(probe_architecture)
    set -e
    test "${arch}" = 'unknown'
)

assert_that_cache_key_includes_architecture()
(
    mock_uname_arm64
    # Create a mock config file for cache key generation
    testdir=$(mktemp -d)
    prefix="${testdir}/opt/local"
    mkdir -p "${prefix}/etc"
    echo "test: config" > "${prefix}/etc/setup-macports.yaml"

    # Mock probe_macos to return a known value
    probe_macos()
    {
	echo 'Sequoia'
    }

    # Mock cache_key function (from configure_macports)
    # We need to redefine it here since configure_macports is not sourced
    cache_key()
    {
	local macos arch
	macos=$(probe_macos)
	arch=$(probe_architecture)
	openssl ripemd160 "${macports_prefix}/etc/setup-macports.yaml"\
	    | awk -v "macos=${macos}" -v "arch=${arch}" '{print(macos "-" arch "-" $2)}'
    }

    # Get cache key
    macports_prefix="${prefix}"
    cache_key_output=$(cache_key)

    # Clean up
    rm -rf "${testdir}"

    set -e
    # Cache key should be in format: {macos}-{arch}-{hash}
    # Should contain "Sequoia-arm64-"
    case "${cache_key_output}" in
	Sequoia-arm64-*)
	    # Correct format
	    ;;
	*)
	    exit 1
	    ;;
    esac
)

testsuite_main\
    assert_that_macos11_is_detected\
    assert_that_macos12_is_detected\
    assert_that_macos26_is_detected\
    assert_that_linux_is_detected\
    assert_that_arm64_architecture_is_detected\
    assert_that_x86_64_architecture_is_detected\
    assert_that_unknown_architecture_returns_unknown\
    assert_that_cache_key_includes_architecture\

# End of file `macos'
